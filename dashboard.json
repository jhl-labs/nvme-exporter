{
  "uid": "nvme-fleet-v4",
  "title": "NVMe Fleet Monitor (Overview + Per-Instance Detail, no EOL/Health)",
  "schemaVersion": 38,
  "version": 4,
  "editable": true,
  "timezone": "browser",
  "refresh": "30s",
  "time": { "from": "now-24h", "to": "now" },
  "templating": {
    "list": [
      {
        "name": "instance",
        "type": "query",
        "datasource": null,
        "query": "label_values(nvme_temperature, instance)",
        "includeAll": true,
        "allValue": ".*",
        "multi": true,
        "refresh": 2,
        "sort": 1,
        "description": "서버/노드 라벨(instance) — 여러 개 선택 가능(기본: 전체)"
      },
      {
        "name": "device",
        "type": "query",
        "datasource": null,
        "query": "label_values(nvme_temperature{instance=~\"$instance\"}, device)",
        "includeAll": true,
        "allValue": ".*",
        "multi": true,
        "refresh": 2,
        "sort": 2,
        "description": "디바이스 라벨(nvme0n1 등) — 여러 개 선택 가능(기본: 전체)"
      }
    ]
  },
  "annotations": { "list": [] },
  "panels": [
    {
      "type": "bargauge",
      "title": "온도(°C) — 전체",
      "description": "각 instance/device의 현재 컨트롤러 온도",
      "gridPos": { "x": 0, "y": 0, "w": 8, "h": 7 },
      "targets": [
        { "expr": "nvme_temperature{instance=~\"$instance\", device=~\"$device\"}", "legendFormat": "{{instance}} {{device}}", "instant": true }
      ],
      "options": { "displayMode": "gradient", "orientation": "horizontal" },
      "fieldConfig": {
        "defaults": {
          "unit": "celsius",
          "thresholds": { "mode": "absolute", "steps": [ { "color": "green" }, { "color": "orange", "value": 60 }, { "color": "red", "value": 80 } ] }
        }
      }
    },
    {
      "type": "bargauge",
      "title": "스페어(%) — 전체",
      "description": "예비 블록 여유율(available_spare). threshold 이하면 위험",
      "gridPos": { "x": 8, "y": 0, "w": 8, "h": 7 },
      "targets": [
        { "expr": "nvme_available_spare{instance=~\"$instance\", device=~\"$device\"}", "legendFormat": "{{instance}} {{device}}", "instant": true }
      ],
      "options": { "displayMode": "basic", "orientation": "horizontal" },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "thresholds": { "mode": "absolute", "steps": [ { "color": "red" }, { "color": "yellow", "value": 10 }, { "color": "green", "value": 20 } ] }
        }
      }
    },
    {
      "type": "bargauge",
      "title": "수명 사용률(%) — 전체",
      "description": "percentage_used(SSD 내구 수명 지표)",
      "gridPos": { "x": 16, "y": 0, "w": 8, "h": 7 },
      "targets": [
        { "expr": "nvme_percentage_used{instance=~\"$instance\", device=~\"$device\"}", "legendFormat": "{{instance}} {{device}}", "instant": true }
      ],
      "options": { "displayMode": "gradient", "orientation": "horizontal" },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "min": 0, "max": 100,
          "thresholds": { "mode": "absolute", "steps": [ { "color": "green" }, { "color": "orange", "value": 70 }, { "color": "red", "value": 90 } ] }
        }
      }
    },

    {
      "type": "timeseries",
      "title": "온도 트렌드 — 전체",
      "description": "nvme_temperature 시계열(선택된 instance/device 전체)",
      "gridPos": { "x": 0, "y": 7, "w": 12, "h": 9 },
      "targets": [
        { "expr": "nvme_temperature{instance=~\"$instance\", device=~\"$device\"}", "legendFormat": "{{instance}} {{device}}" }
      ],
      "fieldConfig": { "defaults": { "unit": "celsius" } },
      "options": { "legend": { "showLegend": true, "displayMode": "list", "placement": "bottom" } }
    },
    {
      "type": "timeseries",
      "title": "수명 사용률 트렌드 — 전체",
      "description": "nvme_percentage_used 시계열",
      "gridPos": { "x": 12, "y": 7, "w": 12, "h": 9 },
      "targets": [
        { "expr": "nvme_percentage_used{instance=~\"$instance\", device=~\"$device\"}", "legendFormat": "{{instance}} {{device}}" }
      ],
      "fieldConfig": { "defaults": { "unit": "percent" } },
      "options": { "legend": { "showLegend": true, "displayMode": "list", "placement": "bottom" } }
    },

    {
      "type": "timeseries",
      "title": "TBW 트렌드 — 전체",
      "description": "nvme_tbw_terabytes 시계열",
      "gridPos": { "x": 0, "y": 16, "w": 12, "h": 8 },
      "targets": [
        { "expr": "nvme_tbw_terabytes{instance=~\"$instance\", device=~\"$device\"}", "legendFormat": "{{instance}} {{device}}" }
      ],
      "fieldConfig": { "defaults": { "unit": "short" } },
      "options": { "legend": { "showLegend": true, "displayMode": "list", "placement": "bottom" } }
    },
    {
      "type": "timeseries",
      "title": "IO 증가량(5m) — 전체",
      "description": "increase(nvme_data_units_read|written[5m]) — 최근 5분 IO 활동도",
      "gridPos": { "x": 12, "y": 16, "w": 12, "h": 8 },
      "targets": [
        { "expr": "increase(nvme_data_units_read{instance=~\"$instance\", device=~\"$device\"}[5m])", "legendFormat": "{{instance}} {{device}} read Δ" },
        { "expr": "increase(nvme_data_units_written{instance=~\"$instance\", device=~\"$device\"}[5m])", "legendFormat": "{{instance}} {{device}} write Δ" }
      ],
      "fieldConfig": { "defaults": { "unit": "short" } },
      "options": { "legend": { "showLegend": true, "displayMode": "list", "placement": "bottom" } }
    },

    {
      "type": "timeseries",
      "title": "Thermal Mgmt (전이/시간) — 전체",
      "description": "최근 스로틀링 징후 확인 (전이 증가량/시간 증가율)",
      "gridPos": { "x": 0, "y": 24, "w": 24, "h": 8 },
      "targets": [
        { "expr": "increase(nvme_thermal_mgmt_t1_trans{instance=~\"$instance\", device=~\"$device\"}[10m])", "legendFormat": "{{instance}} {{device}} t1_trans(Δ10m)" },
        { "expr": "increase(nvme_thermal_mgmt_t2_trans{instance=~\"$instance\", device=~\"$device\"}[10m])", "legendFormat": "{{instance}} {{device}} t2_trans(Δ10m)" },
        { "expr": "rate(nvme_thermal_mgmt_t1_time{instance=~\"$instance\", device=~\"$device\"}[5m])", "legendFormat": "{{instance}} {{device}} t1_time rate" },
        { "expr": "rate(nvme_thermal_mgmt_t2_time{instance=~\"$instance\", device=~\"$device\"}[5m])", "legendFormat": "{{instance}} {{device}} t2_time rate" }
      ],
      "fieldConfig": { "defaults": { "unit": "ops" } },
      "options": { "legend": { "showLegend": true, "displayMode": "list", "placement": "bottom" } }
    },

    { "type": "row", "title": "인스턴스별 상세 (반복)", "gridPos": { "x": 0, "y": 32, "w": 24, "h": 1 }, "repeat": "instance", "panels": [] },

    {
      "type": "timeseries",
      "title": "[${instance}] 디바이스별 온도",
      "gridPos": { "x": 0, "y": 33, "w": 12, "h": 8 },
      "targets": [
        { "expr": "nvme_temperature{instance=~\"$instance\", device=~\"$device\"}", "legendFormat": "{{device}}" }
      ],
      "fieldConfig": { "defaults": { "unit": "celsius" } },
      "options": { "legend": { "showLegend": true, "displayMode": "list", "placement": "bottom" } }
    },
    {
      "type": "timeseries",
      "title": "[${instance}] 센서 온도(1/2)",
      "gridPos": { "x": 12, "y": 33, "w": 12, "h": 8 },
      "targets": [
        { "expr": "nvme_temperature_sensor_1{instance=~\"$instance\", device=~\"$device\"}", "legendFormat": "{{device}} s1" },
        { "expr": "nvme_temperature_sensor_2{instance=~\"$instance\", device=~\"$device\"}", "legendFormat": "{{device}} s2" }
      ],
      "fieldConfig": { "defaults": { "unit": "celsius" } },
      "options": { "legend": { "showLegend": true, "displayMode": "list", "placement": "bottom" } }
    },
    {
      "type": "timeseries",
      "title": "[${instance}] 수명 사용률(%)",
      "gridPos": { "x": 0, "y": 41, "w": 8, "h": 8 },
      "targets": [
        { "expr": "nvme_percentage_used{instance=~\"$instance\", device=~\"$device\"}", "legendFormat": "{{device}}" }
      ],
      "fieldConfig": { "defaults": { "unit": "percent" } },
      "options": { "legend": { "showLegend": true, "displayMode": "list", "placement": "bottom" } }
    },
    {
      "type": "timeseries",
      "title": "[${instance}] IO 증가량(5m)",
      "gridPos": { "x": 8, "y": 41, "w": 8, "h": 8 },
      "targets": [
        { "expr": "increase(nvme_data_units_read{instance=~\"$instance\", device=~\"$device\"}[5m])", "legendFormat": "{{device}} read Δ" },
        { "expr": "increase(nvme_data_units_written{instance=~\"$instance\", device=~\"$device\"}[5m])", "legendFormat": "{{device}} write Δ" }
      ],
      "fieldConfig": { "defaults": { "unit": "short" } },
      "options": { "legend": { "showLegend": true, "displayMode": "list", "placement": "bottom" } }
    },
    {
      "type": "timeseries",
      "title": "[${instance}] Thermal Mgmt (전이/시간)",
      "gridPos": { "x": 16, "y": 41, "w": 8, "h": 8 },
      "targets": [
        { "expr": "increase(nvme_thermal_mgmt_t1_trans{instance=~\"$instance\", device=~\"$device\"}[10m])", "legendFormat": "{{device}} t1_trans(Δ10m)" },
        { "expr": "increase(nvme_thermal_mgmt_t2_trans{instance=~\"$instance\", device=~\"$device\"}[10m])", "legendFormat": "{{device}} t2_trans(Δ10m)" },
        { "expr": "rate(nvme_thermal_mgmt_t1_time{instance=~\"$instance\", device=~\"$device\"}[5m])", "legendFormat": "{{device}} t1_time rate" },
        { "expr": "rate(nvme_thermal_mgmt_t2_time{instance=~\"$instance\", device=~\"$device\"}[5m])", "legendFormat": "{{device}} t2_time rate" }
      ],
      "fieldConfig": { "defaults": { "unit": "ops" } },
      "options": { "legend": { "showLegend": true, "displayMode": "list", "placement": "bottom" } }
    },
    {
      "type": "timeseries",
      "title": "[${instance}] TBW (누적 TB)",
      "gridPos": { "x": 0, "y": 49, "w": 24, "h": 8 },
      "targets": [
        { "expr": "nvme_tbw_terabytes{instance=~\"$instance\", device=~\"$device\"}", "legendFormat": "{{device}}" }
      ],
      "fieldConfig": { "defaults": { "unit": "short" } },
      "options": { "legend": { "showLegend": true, "displayMode": "list", "placement": "bottom" } }
    }
  ]
}
